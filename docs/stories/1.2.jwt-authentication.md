# Story 1.2: JWT Authentication Endpoint

## Status

Draft

## Story

**As a** client application,
**I want** to send a user's email and password to a `POST /auth/token` endpoint,
**so that** I can receive a JWT access token to authenticate future API requests.

## Acceptance Criteria

1.  The endpoint must be located at `POST /auth/token`.
2.  It must accept a `username` (which will be the user's email) and a `password` in a form data body, following the OAuth2 standard.
3.  If the email and password are valid, the endpoint returns a `200 OK` status code with a JSON body containing an `access_token` (the JWT) and a `token_type` of "bearer".
4.  If the email does not exist or the password is a mismatch, the endpoint returns a `401 Unauthorized` HTTP status code with an appropriate error message.
5.  The generated JWT access token must contain the user's ID (`sub` claim) and an expiration time (`exp` claim).

## Tasks / Subtasks

*   `[ ]` **Task 1: Create the `/auth/token` endpoint.** (AC: #1, #2)
    *   `[ ]` Subtask 1.1: Create a new router file in `apps/api/routers/auth.py`.
    *   `[ ]` Subtask 1.2: Define the `POST /auth/token` endpoint, using FastAPI's `OAuth2PasswordRequestForm` dependency to handle the form data.
*   `[ ]` **Task 2: Implement the authentication and token generation logic.** (AC: #3, #4, #5)
    *   `[ ]` Subtask 2.1: Create an `authenticate_user` function in the `AuthService` that takes an email and password.
    *   `[ ]` Subtask 2.2: This function should fetch the user by email from the `UserRepository`.
    *   `[ ]` Subtask 2.3: It should then use the `bcrypt` library to verify the provided password against the stored hash.
    *   `[ ]` Subtask 2.4: Create a `create_access_token` function that generates a JWT containing the user's ID as the `sub` claim and a configured expiration time.
*   `[ ]` **Task 3: Write tests for the authentication endpoint.**
    *   `[ ]` Subtask 3.1: Write integration tests for the `/auth/token` endpoint, covering both successful login (200) and failed login (401) scenarios.
    *   `[ ]` Subtask 3.2: Write a unit test for the `create_access_token` function to ensure the JWT payload is correct.

## Dev Notes

*   **Framework:** Use FastAPI's built-in security utilities, specifically `OAuth2PasswordBearer` and `OAuth2PasswordRequestForm`, to handle the token flow. This is the standard and recommended practice.
*   **JWT Creation:** Use the `python-jose` library to create and sign the JWT. The secret key should be read from the `JWT_SECRET_KEY` environment variable.
*   **Token Expiration:** The access token should have a short expiration time (e.g., 15-30 minutes) for security. We will handle token refreshing in a future story.
*   **Dependencies:** This story depends on Story 1.1 being complete, as it needs to query the `users` table and verify a hashed password.
*   **Testing:** Use the `TestClient` to simulate the form data POST request in your tests.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
