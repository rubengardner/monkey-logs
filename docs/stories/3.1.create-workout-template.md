# Story 3.1: Create Workout Template

## Status

Draft

## Story

**As a** developer,
**I want** a `POST /workout-templates` endpoint,
**so that** a user can save a structured workout routine as a reusable template.

## Acceptance Criteria

1.  A `POST` request to `/workout-templates` with a valid JSON payload successfully creates a new `WorkoutTemplate` record in the database.
2.  The endpoint must be protected, and the `user_id` for the template must be derived from the authenticated user's JWT token.
3.  The request body must be a complex JSON object that is successfully validated against the `WorkoutTemplateCreate` model, including the nested `ActivityGroup`s and the polymorphic `WorkoutTemplateItem`s with their `sets`.
4.  A successful request returns a `201 Created` HTTP status code and the newly created `WorkoutTemplate` object.
5.  The request must fail with a `422 Unprocessable Entity` if any part of the nested structure is invalid (e.g., an `ActivityGroup` has an incorrect `groupType`, or the `sets` for a `WorkoutTemplateItem` don't match its `exerciseType`).

## Tasks / Subtasks

*   `[ ]` **Task 1: Create comprehensive Pydantic models for `WorkoutTemplate` and its nested components.** (AC: #1, #3, #5)
    *   `[ ]` Subtask 1.1: Define Pydantic models for all `Set` types (e.g., `StrengthRepsSet`, `ClimbSet`).
    *   `[ ]` Subtask 1.2: Define the `WorkoutTemplateItemCreate` model as a discriminated union, incorporating all `ExerciseType`s and their respective `Set` types.
    *   `[ ]` Subtask 1.3: Define the `ActivityGroupCreate` model, including its `groupType`, `rounds`, `restAfterGroupSeconds`, and a list of `WorkoutTemplateItemCreate`s.
    *   `[ ]` Subtask 1.4: Define the top-level `WorkoutTemplateCreate` model, including `name`, `description`, and a list of `ActivityGroupCreate`s.
    *   `[ ]` Subtask 1.5: Create a `WorkoutTemplateRead` model for the response.
*   `[ ]` **Task 2: Implement the `POST /workout-templates` router and endpoint.** (AC: #1, #2)
    *   `[ ]` Subtask 2.1: Create a new router file in `apps/api/routers/workout_templates.py`.
    *   `[ ]` Subtask 2.2: Define the `POST /workout-templates` endpoint, ensuring it is protected by the `get_current_user` dependency.
*   `[ ]` **Task 3: Implement the template creation service and repository logic.** (AC: #1)
    *   `[ ]` Subtask 3.1: Create a `WorkoutTemplateService` to contain the business logic.
    *   `[ ]` Subtask 3.2: Create a `WorkoutTemplateRepository` with a `create_template` method that handles the database insertion.
    *   `[ ]` Subtask 3.3: The repository must store the `activities` field as a `JSONB` column in the database.
*   `[ ]` **Task 4: Update the database schema.**
    *   `[ ]` Subtask 4.1: Add a new `workout_templates` table to the database schema, including a `user_id` foreign key and an `activities` column of type `JSONB`.
*   `[ ]` **Task 5: Write tests for the template creation endpoint.**
    *   `[ ]` Subtask 5.1: Write an integration test for a successful creation (201) with a complex template payload (e.g., including multiple `ActivityGroup`s and different `WorkoutTemplateItem` types).
    *   `[ ]` Subtask 5.2: Write integration tests for validation errors (422) for various invalid nested structures.
    *   `[ ]` Subtask 5.3: Write a test for the unauthorized case (401).

## Dev Notes

*   **Pydantic Model Definition:** This story's primary challenge lies in accurately defining the nested Pydantic models for `WorkoutTemplateCreate`. Pay close attention to the discriminated unions for `WorkoutTemplateItemCreate` and ensure all `Set` types are correctly integrated. This is where the complex validation will occur.
*   **Database Storage:** The entire `activities` structure (list of `ActivityGroup`s, each containing `WorkoutTemplateItem`s with their `sets`) will be stored in a single `JSONB` column in the `workout_templates` table. SQLModel/SQLAlchemy will handle the serialization of the Pydantic model into JSONB.
*   **Schema Migration:** Remember to create a database migration to add the new `workout_templates` table with the appropriate columns, including the `activities JSONB` column and the `user_id` foreign key.
*   **Dependencies:** This story assumes that `Exercise` definitions already exist in the database, as `WorkoutTemplateItem`s reference `exerciseId`. For testing, you'll need to create some dummy `Exercise` records first.
*   **Thorough Testing:** Given the complexity of the nested Pydantic validation, ensure your tests cover various valid and invalid template structures, including different `groupType`s and `exerciseType`s.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
