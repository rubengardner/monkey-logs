# Story 2.2: Log Exercise

## Status

Draft

## Story

**As a** developer,
**I want** a `POST /logs/exercise` endpoint,
**so that** a client application can record the performance of a specific exercise (e.g., sets, reps, weight) within a given `Workout`.

## Acceptance Criteria

1.  A `POST` request to `/logs/exercise` with a valid `workoutId`, `exerciseId`, `exerciseType`, and `sets` payload creates a new `ExerciseLog` record in the database.
2.  The endpoint must be protected, and the `user_id` for the log must be derived from the authenticated user's JWT token.
3.  The `sets` field in the request body must be a JSON array that is successfully validated against the Pydantic model corresponding to the provided `exerciseType`.
4.  A successful request returns a `201 Created` HTTP status code and the newly created `ExerciseLog` object.
5.  The request must fail with a `404 Not Found` if the provided `workoutId` or `exerciseId` do not exist.
6.  The request must fail with a `403 Forbidden` if the authenticated user does not own the `Workout` they are trying to log against.
7.  The request must fail with a `422 Unprocessable Entity` if the `sets` payload does not match the schema for the given `exerciseType`.

## Tasks / Subtasks

*   `[ ]` **Task 1: Create Pydantic models for exercise logging.** (AC: #1, #3, #7)
    *   `[ ]` Subtask 1.1: Create the full set of Pydantic models for each exercise type's `sets` (e.g., `StrengthRepsSet`, `HangboardSet`).
    *   `[ ]` Subtask 1.2: Create the discriminated union `ExerciseLogCreate` model that accepts the `workoutId`, `exerciseId`, `exerciseType`, and the polymorphic `sets` payload.
*   `[ ]` **Task 2: Implement the `/logs/exercise` router and endpoint.** (AC: #1, #2, #5, #6)
    *   `[ ]` Subtask 2.1: Create a new router file in `apps/api/routers/exercise_logs.py`.
    *   `[ ]` Subtask 2.2: Define the `POST /logs/exercise` endpoint, ensuring it is protected by the `get_current_user` dependency.
*   `[ ]` **Task 3: Implement the exercise logging service and repository logic.** (AC: #1, #5, #6)
    *   `[ ]` Subtask 3.1: Create an `ExerciseLogService` to contain the business logic.
    *   `[ ]` Subtask 3.2: The service must verify that the `workoutId` exists and belongs to the current user before proceeding.
    *   `[ ]` Subtask 3.3: Create an `ExerciseLogRepository` with a `create_log` method that handles the database insertion, storing the `sets` payload in the `JSONB` column.
*   `[ ]` **Task 4: Write tests for the exercise logging endpoint.**
    *   `[ ]` Subtask 4.1: Write integration tests for the success case (201) with at least two different `exerciseType` payloads.
    *   `[ ]` Subtask 4.2: Write integration tests for the failure cases: invalid `sets` payload (422), workout not found (404), and user not authorized for workout (403).

## Dev Notes

*   **Polymorphism with Pydantic:** This is the key challenge of this story. Use a discriminated union in your Pydantic `ExerciseLogCreate` model to handle the different `sets` structures based on the `exerciseType` field. This will allow FastAPI to validate the incoming data automatically.
*   **Authorization:** A critical part of the service logic is ensuring that the user making the request is the owner of the `Workout` they are logging against. The `WorkoutRepository` will need a method to fetch a workout by its ID and user ID to verify ownership.
*   **JSONB in Repository:** When using SQLModel or SQLAlchemy in the repository, the `sets` data (which will be a list of Pydantic models) can be passed directly to the `JSONB` column. The library will handle the serialization.
*   **Dependencies:** This story depends on Story 2.1 being complete, as it requires a `Workout` to exist before an `ExerciseLog` can be added to it.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
