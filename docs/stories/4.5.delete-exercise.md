# Story 4.5: Delete Exercise

## Status

Draft

## Story

**As a** developer,
**I want** a `DELETE /exercises/{exercise_id}` endpoint,
**so that** a user can permanently delete their custom exercise definitions.

## Acceptance Criteria

1.  A `DELETE` request to `/exercises/{exercise_id}` permanently deletes the specified `Exercise` from the database.
2.  A successful deletion returns a `204 No Content` HTTP status code with an empty response body.
3.  The endpoint must be protected, returning `401 Unauthorized` if the user is not authenticated.
4.  If the `exercise_id` does not exist, the endpoint must return a `404 Not Found`.
5.  If the `exercise_id` exists but is a system-defined exercise (i.e., `user_id` is `NULL`), the endpoint must return a `403 Forbidden`. System exercises are immutable and undeletable.
6.  If the `exercise_id` exists but is not owned by the authenticated user, the endpoint must return a `403 Forbidden`.
7.  If the `exercise` is currently referenced by any `ExerciseLog` or `WorkoutTemplate`, the endpoint must return a `409 Conflict` HTTP status code with a clear error message, as it cannot be deleted due to data integrity constraints.

## Tasks / Subtasks

*   `[ ]` **Task 1: Implement the `DELETE /exercises/{exercise_id}` endpoint.** (AC: #1, #2, #3)
    *   `[ ]` Subtask 1.1: Add the new `DELETE` endpoint with an `exercise_id` path parameter to the `apps/api/routers/exercises.py` router.
    *   `[ ]` Subtask 1.2: Ensure the endpoint is protected by the `get_current_user` dependency and returns a `204 No Content` status on success.
*   `[ ]` **Task 2: Implement the delete service and repository logic.** (AC: #1, #4, #5, #6, #7)
    *   `[ ]` Subtask 2.1: Create a `delete_exercise` method in the `ExerciseService`.
    *   `[ ]` Subtask 2.2: The service must first fetch the `Exercise` from the repository to verify its existence and ownership.
    *   `[ ]` Subtask 2.3: The service must check if the exercise is referenced by any `ExerciseLog`s or `WorkoutTemplate`s.
    *   `[ ]` Subtask 2.4: If the user is authorized and no references exist, the service will call a `delete` method in the `ExerciseRepository`.
*   `[ ]` **Task 3: Write tests for the delete endpoint.**
    *   `[ ]` Subtask 3.1: Write an integration test for a successful deletion (204).
    *   `[ ]` Subtask 3.2: Write tests for the failure cases: `404 Not Found`, `403 Forbidden` (for system-defined and not-owned), `409 Conflict` (due to references), and `401 Unauthorized`.

## Dev Notes

*   **Data Integrity Check:** This is the most critical aspect of this story. Before deleting an `Exercise`, the `ExerciseService` (or `ExerciseRepository`) must query the `exercise_logs` and `workout_templates` tables to ensure no records reference the `exercise_id` being deleted. If references exist, a `409 Conflict` must be returned.
*   **Immutability of System Exercises:** Reiterate that system-defined exercises (`user_id IS NULL`) cannot be deleted. The service must enforce this.
*   **Authorization:** As always, verify that the authenticated user is the owner of the custom exercise being deleted.
*   **Dependencies:** Tests will require creating a user, a user-owned exercise, and then creating `ExerciseLog`s and `WorkoutTemplate`s that reference that exercise to test the `409 Conflict` scenario.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
