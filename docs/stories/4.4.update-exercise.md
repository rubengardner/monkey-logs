# Story 4.4: Update Exercise

## Status

Draft

## Story

**As a** developer,
**I want** a `PATCH /exercises/{exercise_id}` endpoint,
**so that** a user can update the details of their custom exercise definitions.

## Acceptance Criteria

1.  A `PATCH` request to `/exercises/{exercise_id}` with a JSON body containing the fields to be updated successfully modifies the specified `Exercise` in the database.
2.  The endpoint must be protected, returning `401 Unauthorized` if the user is not authenticated.
3.  If the `exercise_id` does not exist, the endpoint must return a `404 Not Found`.
4.  If the `exercise_id` exists but is a system-defined exercise (i.e., `user_id` is `NULL`), the endpoint must return a `403 Forbidden`. System exercises are immutable.
5.  If the `exercise_id` exists but is not owned by the authenticated user, the endpoint must return a `403 Forbidden`.
6.  The request must fail with a `422 Unprocessable Entity` if the updated data is invalid (e.g., an invalid `type`).
7.  If the `name` field is updated to a value that already exists for another custom exercise owned by the same user, the endpoint must return a `409 Conflict`.
8.  A successful request returns a `200 OK` status code with the full, updated `Exercise` object.

## Tasks / Subtasks

*   `[ ]` **Task 1: Create a Pydantic model for the update request.** (AC: #1)
    *   `[ ]` Subtask 1.1: Create an `ExerciseUpdate` model where all fields (`name`, `description`, `type`) are optional.
*   `[ ]` **Task 2: Implement the `PATCH /exercises/{exercise_id}` endpoint.** (AC: #1, #2)
    *   `[ ]` Subtask 2.1: Add the new `PATCH` endpoint with an `exercise_id` path parameter to the `apps/api/routers/exercises.py` router.
    *   `[ ]` Subtask 2.2: Ensure the endpoint is protected by the `get_current_user` dependency.
*   `[ ]` **Task 3: Implement the update service and repository logic.** (AC: #1, #3, #4, #5, #7)
    *   `[ ]` Subtask 3.1: Create an `update_exercise` method in the `ExerciseService`.
    *   `[ ]` Subtask 3.2: The service must first fetch the existing `Exercise` from the repository.
    *   `[ ]` Subtask 3.3: It must then verify that the exercise is not system-defined and is owned by the authenticated user.
    *   `[ ]` Subtask 3.4: If the `name` is being updated, the service must check for conflicts with other user-owned exercises.
    *   `[ ]` Subtask 3.5: The service will apply the partial updates to the database model and save the changes.
*   `[ ]` **Task 4: Write tests for the update endpoint.**
    *   `[ ]` Subtask 4.1: Write an integration test for a successful partial update of a user-owned exercise.
    *   `[ ]` Subtask 4.2: Write tests for the failure cases: `404 Not Found`, `403 Forbidden` (for system-defined and not-owned), `422 Unprocessable Entity`, and `409 Conflict`.

## Dev Notes

*   **Immutability of System Exercises:** A core rule for this story is that system-defined exercises (`user_id IS NULL`) cannot be updated. The service layer must explicitly check for this and raise a `403 Forbidden` if an attempt is made.
*   **Ownership Check:** Similar to other update operations, the service must verify that the authenticated user is the owner of the custom exercise being updated.
*   **Name Conflict on Update:** If the `name` field is part of the update, the service must perform a check to ensure the new name doesn't conflict with an existing custom exercise owned by the same user. This is similar to the check in the `create-exercise` story.
*   **Partial Updates:** Use the `update_data.dict(exclude_unset=True)` pattern to apply only the fields provided in the request body.
*   **Dependencies:** Tests will require creating a user, a system exercise, and a user-owned exercise to cover all scenarios.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
