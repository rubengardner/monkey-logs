# Story 3.4: Update Workout Template

## Status

Draft

## Story

**As a** developer,
**I want** a `PATCH /workout-templates/{template_id}` endpoint,
**so that** a user can update the details of an existing `WorkoutTemplate`.

## Acceptance Criteria

1.  A `PATCH` request to `/workout-templates/{template_id}` with a JSON body containing the fields to be updated successfully modifies the specified `WorkoutTemplate` in the database.
2.  The endpoint must be protected, returning `401 Unauthorized` if the user is not authenticated.
3.  If the `template_id` does not exist, the endpoint must return a `404 Not Found`.
4.  If the authenticated user is not the owner of the template, the endpoint must return a `403 Forbidden`.
5.  The request must fail with a `422 Unprocessable Entity` if the updated data is invalid (e.g., the `activities` structure is malformed).
6.  A successful request returns a `200 OK` status code with the full, updated `WorkoutTemplate` object.

## Tasks / Subtasks

*   `[ ]` **Task 1: Create a Pydantic model for the update request.** (AC: #1)
    *   `[ ]` Subtask 1.1: Create a `WorkoutTemplateUpdate` model where all fields (`name`, `description`, `activities`) are optional.
*   `[ ]` **Task 2: Implement the `PATCH /workout-templates/{template_id}` endpoint.** (AC: #1, #2)
    *   `[ ]` Subtask 2.1: Add the new `PATCH` endpoint with a `template_id` path parameter to the `apps/api/routers/workout_templates.py` router.
    *   `[ ]` Subtask 2.2: Ensure the endpoint is protected by the `get_current_user` dependency.
*   `[ ]` **Task 3: Implement the update service and repository logic.** (AC: #1, #3, #4, #5)
    *   `[ ]` Subtask 3.1: Create an `update_template` method in the `WorkoutTemplateService`.
    *   `[ ]` Subtask 3.2: The service must first fetch the existing template from the repository to verify its existence and ownership.
    *   `[ ]` Subtask 3.3: The service will apply the partial updates from the request body to the database model and save the changes.
*   `[ ]` **Task 4: Write tests for the update endpoint.**
    *   `[ ]` Subtask 4.1: Write an integration test for a successful partial update (e.g., changing only the `name`).
    *   `[ ]` Subtask 4.2: Write an integration test for updating the entire `activities` structure.
    *   `[ ]` Subtask 4.3: Write tests for the failure cases: `404 Not Found`, `403 Forbidden`, and `422 Unprocessable Entity`.

## Dev Notes

*   **Partial Updates:** As with the `ExerciseLog` update story, the service layer should handle the partial update by fetching the existing record, applying the changes from the request model, and then saving. Use `update_data.dict(exclude_unset=True)` to get only the fields that were sent in the request.
*   **Authorization:** The ownership check is critical. The service must fetch the template and verify that its `user_id` matches the authenticated user's ID before proceeding with any update.
*   **Dependencies:** The tests for this story will need to create a user and a workout template first, in order to have a template to update.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
