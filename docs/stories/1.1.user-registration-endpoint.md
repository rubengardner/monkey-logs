# Story 1.1: User Registration Endpoint

## Status

Draft

## Story

**As a** developer,
**I want** a `POST /users` endpoint,
**so that** new users can be created in the database.

## Acceptance Criteria

1.  A `POST` request to `/users` with a valid `email` and `password` in the request body successfully creates a new user in the `users` table.
2.  The user's password must be securely hashed using `bcrypt` before it is stored in the database.
3.  A successful request returns a `201 Created` HTTP status code and the newly created user object in the response body (excluding the password hash).
4.  A `POST` request using an email that already exists in the `users` table must fail with a `400 Bad Request` HTTP status code and a clear error message.
5.  A `POST` request with an invalid email format or a password that is too short (e.g., less than 8 characters) must fail with a `422 Unprocessable Entity` HTTP status code and details about the validation errors.

## Tasks / Subtasks

*   `[ ]` **Task 1: Create Pydantic models for user creation.** (AC: #1, #5)
    *   `[ ]` Subtask 1.1: Create a `UserCreate` model for the request body with `email` and `password` fields.
    *   `[ ]` Subtask 1.2: Add validation to the models (e.g., valid email format, password length).
    *   `[ ]` Subtask 1.3: Create a `UserRead` model for the response body to ensure the password hash is not returned.
*   `[ ]` **Task 2: Implement the `/users` router and endpoint.** (AC: #1, #3, #4)
    *   `[ ]` Subtask 2.1: Create a new router file in `apps/api/routers/users.py`.
    *   `[ ]` Subtask 2.2: Define the `POST /users` endpoint function.
    *   `[ ]` Subtask 2.3: Implement the logic to check for existing users and return a 400 error if the email is a duplicate.
*   `[ ]` **Task 3: Implement the user creation service and repository logic.** (AC: #1, #2)
    *   `[ ]` Subtask 3.1: Create a `UserService` to contain the business logic.
    *   `[ ]` Subtask 3.2: Implement a password hashing function using `bcrypt` within the service.
    *   `[ ]` Subtask 3.3: Create a `UserRepository` with a `create_user` method that handles the database insertion.
*   `[ ]` **Task 4: Write tests for the user creation endpoint.**
    *   `[ ]` Subtask 4.1: Write a unit test for the password hashing function.
    *   `[ ]` Subtask 4.2: Write integration tests for the endpoint, covering the success case (201), duplicate email case (400), and validation error case (422).

## Dev Notes

*   **Project Structure:** All backend code should be created within the `apps/api/` directory, following the established structure (`routers/`, `services/`, `db/`, `models/`).
*   **Data Model:** The `users` table schema is defined in `docs/architecture.md`. It includes `id (UUID)`, `email (VARCHAR)`, `name (VARCHAR)`, and `created_at`/`updated_at` fields. Note that this story only requires `email` and a hashed password. The `name` field can be added in a subsequent profile-management story.
*   **Database Access:** All database operations must use the Repository Pattern. A `UserRepository` should be created in `apps/api/db/repository.py` (or a new `users_repository.py` file).
*   **Custom Types:** Use the custom Pydantic types we defined (e.g., `UserId`, `Email`) for type hinting and model fields.
*   **Testing:** Backend tests must be placed in the `apps/api/tests/` directory. Use `pytest` and the `TestClient` for API endpoint testing. Follow the examples in `docs/architecture.md`.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
