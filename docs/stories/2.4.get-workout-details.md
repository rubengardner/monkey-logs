# Story 2.4: Get Workout Details

## Status

Draft

## Story

**As a** developer,
**I want** a `GET /workouts/{workout_id}` endpoint,
**so that** a client application can retrieve the full details of a single `Workout`, including all of the `ExerciseLog`s it contains.

## Acceptance Criteria

1.  A `GET` request to `/workouts/{workout_id}` returns a `200 OK` status code with the full `Workout` object.
2.  The returned `Workout` object must contain a nested list of all `ExerciseLog` objects associated with it.
3.  The endpoint must be protected, returning a `401 Unauthorized` if the user is not authenticated.
4.  If the `workout_id` does not exist, the endpoint must return a `404 Not Found`.
5.  If the authenticated user is not the owner of the requested workout, the endpoint must return a `403 Forbidden`.

## Tasks / Subtasks

*   `[ ]` **Task 1: Update Pydantic models for the detailed response.** (AC: #2)
    *   `[ ]` Subtask 1.1: Modify the `WorkoutRead` model to include a new field, `exercise_logs`, which is a list of `ExerciseLogRead` models.
    *   `[ ]` Subtask 1.2: Ensure the `ExerciseLogRead` model correctly represents the data for a logged exercise.
*   `[ ]` **Task 2: Implement the `GET /workouts/{workout_id}` endpoint.** (AC: #1, #3)
    *   `[ ]` Subtask 2.1: Add the new `GET` endpoint with a path parameter to the `apps/api/routers/workouts.py` router.
    *   `[ ]` Subtask 2.2: Protect the endpoint with the `get_current_user` dependency.
*   `[ ]` **Task 3: Implement the service and repository logic.** (AC: #2, #4, #5)
    *   `[ ]` Subtask 3.1: Create a `get_workout_details` method in the `WorkoutService`.
    *   `[ ]` Subtask 3.2: The service must check for the workout's existence and verify that the authenticated user is the owner.
    *   `[ ]` Subtask 3.3: Create a `get_by_id_with_logs` method in the `WorkoutRepository`. This method should efficiently fetch the `Workout` and its related `ExerciseLog`s in a single query using a relationship loading strategy (e.g., `selectinload`).
*   `[ ]` **Task 4: Write tests for the get workout details endpoint.**
    *   `[ ]` Subtask 4.1: Write an integration test for the success case, ensuring the nested `exercise_logs` are present and correct.
    *   `[ ]` Subtask 4.2: Write tests for the failure cases: `404 Not Found`, `403 Forbidden`, and `401 Unauthorized`.

## Dev Notes

*   **Efficient Querying:** The most critical part of this story is fetching the workout and its related exercise logs efficiently. In the `WorkoutRepository`, use SQLAlchemy/SQLModel's relationship loading capabilities to avoid the "N+1 query problem". Specifically, use `options(selectinload(models.Workout.exercise_logs))` in your query to load the logs in a single, efficient `JOIN`.
*   **Model Relationships:** For the `selectinload` to work, you must define the relationship between the `Workout` and `ExerciseLog` models in your SQLModel definitions (e.g., using `Relationship(back_populates=...)`).
*   **Pydantic Serialization:** Ensure your `WorkoutRead` and `ExerciseLogRead` Pydantic models have `Config.orm_mode = True` (or are SQLModels) so they can be populated directly from the database objects returned by the repository.
*   **Authorization Logic:** The authorization check (ensuring the user owns the workout) must be performed in the `WorkoutService` *before* returning the data. Do not leak data from other users.

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
