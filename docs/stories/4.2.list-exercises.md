# Story 4.2: List Exercises

## Status

Draft

## Story

**As a** developer,
**I want** a `GET /exercises` endpoint,
**so that** a client application can retrieve a list of all available `Exercise` definitions (both system-defined and user-defined) for the authenticated user.

## Acceptance Criteria

1.  A `GET` request to `/exercises` returns a `200 OK` status code with a list of `Exercise` objects.
2.  The endpoint must be protected, returning a `401 Unauthorized` if no valid JWT is provided.
3.  The returned list must include all system-defined exercises (where `user_id` is `NULL`) and all exercises created by the authenticated user.
4.  The returned list of exercises must be sorted by `name` in ascending alphabetical order.
5.  The endpoint must support pagination using `limit` and `offset` query parameters.
6.  The endpoint must support filtering by `type` (e.g., `?type=STRENGTH_REPS`).
7.  The response body should be a JSON object containing the list of exercises and pagination metadata (e.g., `total_count`, `limit`, `offset`).
8.  If no exercises match the criteria, the endpoint should return a `200 OK` with an empty list.
9.  The endpoint must support filtering to return *only* system-defined exercises when a query parameter `is_system=true` is provided.

## Tasks / Subtasks

*   `[ ]` **Task 1: Create Pydantic models for the paginated response.** (AC: #7)
    *   `[ ]` Subtask 1.1: Create a `PaginatedExerciseResponse` model that includes a list of `ExerciseRead` models and fields for `total_count`, `limit`, and `offset`.
*   `[ ]` **Task 2: Implement the `GET /exercises` endpoint.** (AC: #1, #2, #5, #6, #9)
    *   `[ ]` Subtask 2.1: Add the new `GET` endpoint to the `apps/api/routers/exercises.py` router.
    *   `[ ]` Subtask 2.2: Implement `limit`, `offset`, `type`, and `is_system` as query parameters with appropriate default values.
    *   `[ ]` Subtask 2.3: Ensure the endpoint is protected by the `get_current_user` dependency.
*   `[ ]` **Task 3: Implement the service and repository logic for fetching exercises.** (AC: #1, #3, #4, #8, #9)
    *   `[ ]` Subtask 3.1: Create a `get_exercises` method in the `ExerciseService`.
    *   `[ ]` Subtask 3.2: Create a `list_all_by_user_and_system` method in the `ExerciseRepository` that accepts `user_id`, `limit`, `offset`, `exercise_type` filter, and `is_system` filter.
    *   `[ ]` Subtask 3.3: The repository method must efficiently query and combine both system-defined exercises and the authenticated user's exercises, apply sorting, filtering, and pagination, respecting the `is_system` flag.
*   `[ ]` **Task 4: Write tests for the list exercises endpoint.**
    *   `[ ]` Subtask 4.1: Write an integration test for a successful request, verifying that both system and user exercises are returned, correctly sorted and paginated.
    *   `[ ]` Subtask 4.2: Write a test to verify filtering by `type` works correctly.
    *   `[ ]` Subtask 4.3: Write a test to verify filtering by `is_system=true` works correctly, returning only system exercises.
    *   `[ ]` Subtask 4.4: Write a test for the case where a user has no custom exercises but system exercises are returned.
    *   `[ ]` Subtask 4.5: Write a test for the unauthorized case (401).

## Dev Notes

*   **Complex Querying:** The `list_all_by_user_and_system` method in the `ExerciseRepository` is the most complex part. You will likely need to perform two separate queries (one for system exercises where `user_id IS NULL` and one for the authenticated user's exercises where `user_id = current_user_id`) and then combine their results before applying sorting and pagination. Alternatively, a `UNION` SQL clause might be more efficient if your ORM supports it well.
*   **`is_system` Filter:** If `is_system=true` is provided, the repository query should *only* fetch exercises where `user_id IS NULL`. In this case, the `user_id` filter for the authenticated user should be ignored.
*   **Filtering by `type`:** Ensure the `type` filter is applied correctly to both system and user-defined exercises.
*   **Pagination Consistency:** Apply `limit` and `offset` *after* combining and sorting the results to ensure consistent pagination across the unified list.
*   **Dependencies:** For testing, you will need to seed the database with some system-defined exercises (e.g., `user_id=NULL`) and create some user-defined exercises (using the `create-exercise` endpoint from Story 4.1).

## Change Log

| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2025-09-23 | 1.0 | Initial draft | Sarah |
| 2025-09-23 | 1.1 | Added `is_system` filter for listing system-defined exercises. | Sarah |
